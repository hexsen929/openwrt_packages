name: Merge-upstream

on:
  push:
    paths:
      - '.github/workflows/upstream.yml'
      - '.gitignore'
      - 'diy/**'
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ssh'
        required: false
        default: 'true'
  watch:
    types: started
  repository_dispatch:

jobs:
  merge:
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id
    runs-on: Ubuntu-24.04
    steps:

    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set git identity
      run: |
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        sudo timedatectl set-timezone "Asia/Shanghai"

    - name: Sync upstream
      run: |
        shopt -s extglob
        git rm -r --cache * >/dev/null 2>&1 &
        rm -rf $(find ./* -maxdepth 0 -type d ! -name "diy") >/dev/null 2>&1

        #############################
        # å®šä¹‰å‡½æ•°
        #############################

        git_clone() (
          git clone --depth 1 "$1" "$2" || true
        )

        git_sparse_clone() (
          branch="$1"; rurl="$2"; localdir="$3"; shift 3
          git clone -b "$branch" --depth 1 --filter=blob:none --sparse "$rurl" "$localdir"
          cd "$localdir"
          git sparse-checkout init --cone
          git sparse-checkout set "$@"
          mv -n "$@" ../
          cd ..
          rm -rf "$localdir"
        )

        mvdir() {
          mv -n $(find "$1"/* -maxdepth 0 -type d) ./
          rm -rf "$1"
        }

        #############################
        # å¹¶å‘ä»»åŠ¡ 1
        #############################
        (
          git_clone https://github.com/xiaorouji/openwrt-passwall.git openwrt-passwall
          mv openwrt-passwall/luci-app-passwall ./
          rm -rf openwrt-passwall

          git_clone https://github.com/fw876/helloworld helloworld
          mvdir helloworld
        ) &

        #############################
        # å¹¶å‘ä»»åŠ¡ 2
        #############################
        (
          git_clone https://github.com/jerrykuku/luci-theme-argon luci-theme-argon
          git_clone https://github.com/jerrykuku/luci-app-argon-config luci-app-argon-config
          git_clone https://github.com/asvow/luci-app-tailscale luci-app-tailscale
          git_clone https://github.com/lisaac/luci-app-diskman diskmannm
          mv diskmannm/applications/* ./
          rm -rf diskmannm

          git_clone https://github.com/EasyTier/luci-app-easytier easytiermv
          mv -n easytiermv/luci-app-easytier ./
          mv -n easytiermv/easytier ./
          rm -rf easytiermv
        ) &

        #############################
        # å¹¶å‘ä»»åŠ¡ 3
        #############################
        (
          git_clone https://github.com/xiaorouji/openwrt-passwall-packages passwallpkgs
          mv passwallpkgs/* ./
          rm -rf passwallpkgs

          git_clone https://github.com/xiaorouji/openwrt-passwall2 passwall2
          mv -n passwall2/luci-app-passwall2 ./
          rm -rf passwall2
        ) &

        #############################
        # å¹¶å‘ä»»åŠ¡ 4
        #############################
        (
          git_clone https://github.com/gdy666/luci-app-lucky lukymv
          mv -n lukymv/luci-app-lucky ./
          mv -n lukymv/lucky ./
          rm -rf lukymv

          git_clone https://github.com/sbwml/luci-app-mosdns mosdnsmv
          mv -n mosdnsmv/luci-app-mosdns ./
          mv -n mosdnsmv/mosdns mosdnsmv/v2dat ./
          rm -rf mosdnsmv

          git_clone https://github.com/chenmozhijin/luci-app-socat luci-app-socat
          mv luci-app-socat/luci-app-socat ./
          rm -rf luci-app-socat
        ) &

        #############################
        # å¹¶å‘ä»»åŠ¡ 5ï¼ˆSparse Cloneï¼‰
        #############################
        (
          git_sparse_clone master https://github.com/immortalwrt/packages.git pkgim net/vsftpd
          git_sparse_clone master https://github.com/coolsnowwolf/lede leanpkg package/lean/ddns-scripts_dnspod
          git_sparse_clone master https://github.com/coolsnowwolf/luci leanpkg2 applications/luci-app-wireguard
        ) &

        #############################
        # å¹¶å‘ä»»åŠ¡ 6ï¼ˆimmortalwrt/luci openwrt-24.10ï¼‰
        #############################
        (
          apps=(
            applications/luci-app-webadmin
            applications/luci-app-samba4
            applications/luci-app-ramfree
            applications/luci-app-nfs
            applications/luci-app-zerotier
            applications/luci-app-natmap
            applications/luci-app-vsftpd
          )

          git_sparse_clone openwrt-24.10 https://github.com/immortalwrt/luci.git immortal "${apps[@]}"
        ) &

        wait

    - name: Replace text in files
      run: |
        sed -i 's/include ..\/..\/luci.mk/include $(TOPDIR)\/feeds\/luci\/luci.mk/' $(find ./ -type f -name "Makefile")

    - name: Delete duplicated packages
      run: |
        shopt -s extglob
        rm -Rf */.git

    - name: SSH connection to Actions
      uses: kiddin9/debugger-action@master
      if: github.event.inputs.ssh == 'true'

    - name: Apply
      run: |
        Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
        git add .
        git commit -m "${Emoji[$RANDOM % ${#Emoji[@]}]} Sync $(date '+%Y-%m-%d %H:%M:%S')"
        git push -f

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@main
      continue-on-error: true
      with:
        retain_days: 1
        keep_minimum_runs: 3
